"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[7551],{9613:function(e,a,t){t.d(a,{Zo:function(){return c},kt:function(){return m}});var n=t(9496);function r(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function s(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function i(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?s(Object(t),!0).forEach((function(a){r(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function o(e,a){if(null==e)return{};var t,n,r=function(e,a){if(null==e)return{};var t,n,r={},s=Object.keys(e);for(n=0;n<s.length;n++)t=s[n],a.indexOf(t)>=0||(r[t]=e[t]);return r}(e,a);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)t=s[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=n.createContext({}),p=function(e){var a=n.useContext(l),t=a;return e&&(t="function"==typeof e?e(a):i(i({},a),e)),t},c=function(e){var a=p(e.components);return n.createElement(l.Provider,{value:a},e.children)},d={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},u=n.forwardRef((function(e,a){var t=e.components,r=e.mdxType,s=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),u=p(t),m=r,f=u["".concat(l,".").concat(m)]||u[m]||d[m]||s;return t?n.createElement(f,i(i({ref:a},c),{},{components:t})):n.createElement(f,i({ref:a},c))}));function m(e,a){var t=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var s=t.length,i=new Array(s);i[0]=u;var o={};for(var l in a)hasOwnProperty.call(a,l)&&(o[l]=a[l]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var p=2;p<s;p++)i[p]=t[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,t)}u.displayName="MDXCreateElement"},7274:function(e,a,t){t.r(a),t.d(a,{frontMatter:function(){return o},contentTitle:function(){return l},metadata:function(){return p},toc:function(){return c},default:function(){return u}});var n=t(9624),r=t(42),s=(t(9496),t(9613)),i=["components"],o={sidebar_position:3},l="Databases",p={unversionedId:"connect/databases",id:"connect/databases",title:"Databases",description:"Since database connections are also commonly defined by an URL or URI, you might expect that there is some kind of",source:"@site/docs/connect/databases.md",sourceDirName:"connect",slug:"/connect/databases",permalink:"/WSF/docs/connect/databases",editUrl:"https://github.com/Divine-Software/WSF/tree/master/website/docs/connect/databases.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"Web Resources",permalink:"/WSF/docs/connect/http"},next:{title:"Data Formats",permalink:"/WSF/docs/parse/"}},c=[{value:"DB References",id:"db-references",children:[],level:2},{value:"Reading Rows",id:"reading-rows",children:[],level:2},{value:"Writing Rows",id:"writing-rows",children:[],level:2},{value:"Notifications and Change Data Capture",id:"notifications-and-change-data-capture",children:[],level:2}],d={toc:c};function u(e){var a=e.components,t=(0,r.Z)(e,i);return(0,s.kt)("wrapper",(0,n.Z)({},d,t,{components:a,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"databases"},"Databases"),(0,s.kt)("p",null,"Since database connections are also commonly defined by an URL or URI, you might expect that there is some kind of\nsupport for databases in one of the ",(0,s.kt)("a",{parentName:"p",href:"/WSF/docs/api/classes/divine_uri.DatabaseURI"},"URI subclasses")," as well. And you wouldn't be wrong: The ",(0,s.kt)("a",{parentName:"p",href:"/WSF/docs/api/classes/divine_uri.DatabaseURI#query"},"query")," method\ncan be used to execute arbitrary queries to SQL databases; you can read more about this in the section about ",(0,s.kt)("a",{parentName:"p",href:"/WSF/docs/query/"},"queries"),"."),(0,s.kt)("p",null,"What you might not expect is that most of the other methods of ",(0,s.kt)("a",{parentName:"p",href:"/WSF/docs/api/classes/divine_uri.URI"},"URI")," also work on database URIs. But what does really it\nmean to ",(0,s.kt)("a",{parentName:"p",href:"/WSF/docs/api/classes/divine_uri.DatabaseURI#load"},"load"),", ",(0,s.kt)("a",{parentName:"p",href:"/WSF/docs/api/classes/divine_uri.DatabaseURI#save"},"save")," or ",(0,s.kt)("a",{parentName:"p",href:"/WSF/docs/api/classes/divine_uri.DatabaseURI#remove"},"remove")," a database? Probably not what you think at first."),(0,s.kt)("h2",{id:"db-references"},"DB References"),(0,s.kt)("p",null,"Truth to be told, this author is a bit old-school when it comes to databases; I don't mind writing SQL queries and I'm\nnot really an ",(0,s.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping"},"ORM")," kind of person",(0,s.kt)("sup",{parentName:"p",id:"fnref-1"},(0,s.kt)("a",{parentName:"sup",href:"#fn-1",className:"footnote-ref"},"1")),". On the other hand, especially when building REST services, writing lots of\ntrivial SQL queries just to access database rows can quickly become a bit repetitive."),(0,s.kt)("p",null,"That's why the WSF provides something we call ",(0,s.kt)("a",{parentName:"p",href:"/WSF/docs/api/classes/divine_uri.DatabaseURI#crud-row-operations-with-db-references"},"DB references"),", a small expression language that lives in the URI's\n",(0,s.kt)("em",{parentName:"p"},"fragment")," part and which defines, in a compact manner, what table, rows and columns a specific URI references."),(0,s.kt)("p",null,"So the answer to the question above is not some kind of database backup and restore handling, but rather direct access\nto table rows inside the database. Let's show some quick examples."),(0,s.kt)("h2",{id:"reading-rows"},"Reading Rows"),(0,s.kt)("p",null,"Assuming you have a ",(0,s.kt)("inlineCode",{parentName:"p"},"users")," table with ",(0,s.kt)("inlineCode",{parentName:"p"},"id")," as primary key, here is how to retrieve it using ",(0,s.kt)("a",{parentName:"p",href:"/WSF/docs/api/classes/divine_uri.DatabaseURI#load"},"load"),", given an ",(0,s.kt)("inlineCode",{parentName:"p"},"userID"),"\nidentifier:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},"const user = await dbURI.$`#users;one?(eq,id,${userID})`.load<User>();\n")),(0,s.kt)("p",null,"The ",(0,s.kt)("inlineCode",{parentName:"p"},"$")," method in URI just creates a new relative URI from a template literal, and in this case we set the fragment part\nwhile leaving everything else as-is. ",(0,s.kt)("inlineCode",{parentName:"p"},"users")," is our table, ",(0,s.kt)("inlineCode",{parentName:"p"},";one"),' means "fetch one single row" and ',(0,s.kt)("inlineCode",{parentName:"p"},"eq"),' means "equals".\nShould you instead want to fetch all users from the US, you\'d write:'),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},"const users = await dbURI.$`#users?(eq,country,us)`.load<User[]>();\n")),(0,s.kt)("p",null,"It's also possible to reference a single cell in the database. In the following example, we retrieve only a user's name\nfrom the database, as a ",(0,s.kt)("inlineCode",{parentName:"p"},"String"),(0,s.kt)("sup",{parentName:"p",id:"fnref-2"},(0,s.kt)("a",{parentName:"sup",href:"#fn-2",className:"footnote-ref"},"2")),"."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},"const name = await dbURI.$`#users(name);scalar?(eq,id,${userID})`.load<String>();\n")),(0,s.kt)("h2",{id:"writing-rows"},"Writing Rows"),(0,s.kt)("p",null,"To insert a row into a table, use ",(0,s.kt)("a",{parentName:"p",href:"/WSF/docs/api/classes/divine_uri.DatabaseURI#append"},"append"),". Depending on what database you use, a generated key is either available\ndirectly (if ",(0,s.kt)("inlineCode",{parentName:"p"},"INSERT ... RETURNING *")," is supported), or via ",(0,s.kt)("a",{parentName:"p",href:"/WSF/docs/api/classes/divine_uri.DBResult#rowkey"},"DBResult.rowKey"),":"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},"import { FIELDS } from '@divine/uri';\n\nconst user = await dbURI.$`#users`.append<User>({ name: 'John Doe', country: 'us' });\nconst userID = user.id ?? user[FIELDS][0].rowKey;\n")),(0,s.kt)("p",null,"Some databases implement ",(0,s.kt)("inlineCode",{parentName:"p"},"UPSERT")," or ",(0,s.kt)("inlineCode",{parentName:"p"},"INSERT ... ON CONFLICT UPDATE ..."),", which updates an existing row if the ",(0,s.kt)("em",{parentName:"p"},"primary\nkey exists"),(0,s.kt)("sup",{parentName:"p",id:"fnref-3"},(0,s.kt)("a",{parentName:"sup",href:"#fn-3",className:"footnote-ref"},"3")),", or inserts the row if it doesn't. For those databases, ",(0,s.kt)("a",{parentName:"p",href:"/WSF/docs/api/classes/divine_uri.DatabaseURI#save"},"save")," may be used too:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},"const user = await dbURI.$`#users`.save<User>({ id: userID, name: 'John Doe', country: 'us' });\n")),(0,s.kt)("p",null,"Existing rows may be updated with ",(0,s.kt)("a",{parentName:"p",href:"/WSF/docs/api/classes/divine_uri.DatabaseURI#modify"},"modify"),", like this:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},"await dbURI.$`#users?(eq,country,se)`.modify({ language: 'sv' });\n")),(0,s.kt)("p",null,"And, naturally, rows can be deleted using ",(0,s.kt)("a",{parentName:"p",href:"/WSF/docs/api/classes/divine_uri.DatabaseURI#remove"},"remove"),":"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},"await dbURI.$`#users(eq,id,${userID})`.remove();\n")),(0,s.kt)("h2",{id:"notifications-and-change-data-capture"},"Notifications and Change Data Capture"),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"/WSF/docs/api/classes/divine_uri.DatabaseURI#watch"},"watch")," allows you to subscribe to a live event feed from the database, which can be very useful for real-time services.\nThis is currently only implemented for PostgreSQL and CockroachDB, but at least MySQL should be able to support this as\nwell some day."),(0,s.kt)("p",null,"Here are a couple of small examples:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},"for await (const ev of dbURI.watch`experimental changefeed FOR orders`) {\n    console.log('New order from CockroachDB', ev);\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},"for await (const ev of dbURI.watch`listen order_channel`) {\n    console.log('New notification from PostgreSQL', ev);\n}\n")),(0,s.kt)("div",{className:"footnotes"},(0,s.kt)("hr",{parentName:"div"}),(0,s.kt)("ol",{parentName:"div"},(0,s.kt)("li",{parentName:"ol",id:"fn-1"},"But if you ",(0,s.kt)("em",{parentName:"li"},"do")," enjoy ",(0,s.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping"},"ORM"),"s such as ",(0,s.kt)("a",{parentName:"li",href:"https://www.prisma.io/"},"Prisma")," or ",(0,s.kt)("a",{parentName:"li",href:"https://typeorm.io/"},"TypeORM"),", then by\nall means, use those great tools instead of our database abstractions. Nothing in the WSF depends on how data is\npersisted or by what methods the data is accessed.",(0,s.kt)("a",{parentName:"li",href:"#fnref-1",className:"footnote-backref"},"\u21a9")),(0,s.kt)("li",{parentName:"ol",id:"fn-2"},"Yes, ",(0,s.kt)("inlineCode",{parentName:"li"},"String"),", not ",(0,s.kt)("inlineCode",{parentName:"li"},"string"),". Since the URI methods also return ",(0,s.kt)("a",{parentName:"li",href:"/WSF/docs/api/interfaces/divine_uri.Metadata"},"Metadata"),"/",(0,s.kt)("a",{parentName:"li",href:"/WSF/docs/api/interfaces/divine_uri.DBMetadata"},"DBMetadata"),", it cannot return primitive\nvalues. To explicitly convert the object to a ",(0,s.kt)("inlineCode",{parentName:"li"},"string"),", use ",(0,s.kt)("inlineCode",{parentName:"li"},"toString")," or ",(0,s.kt)("inlineCode",{parentName:"li"},"valueOf"),".",(0,s.kt)("a",{parentName:"li",href:"#fnref-2",className:"footnote-backref"},"\u21a9")),(0,s.kt)("li",{parentName:"ol",id:"fn-3"},"For this reason, ",(0,s.kt)("a",{parentName:"li",href:"/WSF/docs/api/classes/divine_uri.DatabaseURI#save"},"save")," is unfortunately not available for MySQL: it updates on ",(0,s.kt)("em",{parentName:"li"},"any")," duplicate key conflict, not\njust on primary key conflicts. This is very dangerous and a potential security issue, so we do not support this.",(0,s.kt)("a",{parentName:"li",href:"#fnref-3",className:"footnote-backref"},"\u21a9")))))}u.isMDXComponent=!0}}]);